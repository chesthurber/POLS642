---
title: "W6L1: Assumptions and Logits"
subtitle: "POLS 642 Intermediate Analysis of Political Data"
author: "Dr. Ches Thurber"
format: 
  revealjs:
    theme: simple
execute: 
  echo: true
editor: visual
---

## Plan for Today

1\) Telling Bad Stories

2\) OLS Assumptions

3\) Recap: Binary IVs, Interactions, and Categorical Variables

4\) Binary DVs

## Planning Ahead

-   Friday 2/27: Problem Set #1 Due

-   Thur 3/5: Midterm Exam

## Packages

```{r}
library(gapminder)
library(dplyr)
library(ggplot2)
gapminder <- gapminder
```

# Telling Bad Stories

## Oops

```{r, echo = F, warning = F}

gap.model <- lm(lifeExp~gdpPercap, data = gapminder)
ggplot(gapminder, aes(x = gdpPercap, y = lifeExp))+
    geom_point() +
  geom_smooth(method = "lm", formula = y ~ x) +
  labs(x = "GDP Per Capita", y = "Life Expectancy in Years",
         title = "Economic Development and Life Expectancy",
         subtitle = "Data points are country-years",
         caption = "Source: Gapminder.") + 
  theme_bw()

```

## Problem #1

-   Our model does not tell a very good story about our data

## Problem #2

-   Our model violates the assumptions of OLS regression

-   Specifically, violates assumptions that make the central limit theorem as applied to regression no longer hold

    -   i.e. That if we took infinite samples from the data and ran regressions on each of those samples, the distribution of our calculated slopes ($\hat \beta_1$) would follow a normal distribution with a mean of the population $\beta_1$ and a standard deviation of $\frac{\hat {\sigma} ^2}{N * var(X)}$

## This Is Not Normal

```{r echo=FALSE}
coef_results <- data.frame(intercept = numeric(1000), gdpPercap = numeric(1000))
for (i in 1:1000){
  sample <- sample_n(gapminder, 300)
  model <- lm(lifeExp~gdpPercap, data = sample)
  coef_results[i,] <- coef(model)
}
```

```{r}
hist(coef_results$gdpPercap)
```

## Solutions

1\) Build a better model

2\) Adjust your standard errors

## Build a Better Model

```{r, echo=FALSE}
gap.model.log <- lm(lifeExp~log10(gdpPercap), data = gapminder)
ggplot(gapminder, aes(x = gdpPercap, y = lifeExp))+
    geom_point() +
  geom_smooth(method = "lm", formula = y ~ log10(x)) +
  labs(x = "GDP Per Capita", y = "Life Expectancy in Years",
         title = "Economic Development and Life Expectancy",
         subtitle = "Data points are country-years",
         caption = "Source: Gapminder.") + 
  theme_bw()
```

## Much More Normal

```{r echo=FALSE}
coef_results2 <- data.frame(intercept = numeric(1000), gdpPercap = numeric(1000))
for (i in 1:1000){
  sample <- sample_n(gapminder, 300)
  model.log <- lm(lifeExp~log10(gdpPercap), data = sample)
  coef_results2[i,] <- coef(model.log)
}
```

```{r}
hist(coef_results2$gdpPercap)
```

# OLS Assumptions

## Main Idea

-   Using OLS to draw inferences about the population based on a sample is predicated on the premise that:

    -    repeated samples of the population will produce a distribution of slope estimates that approximates a normal distribution

    -   that normal distribution will be centered on the actual population slope

    -   and it will have a specific standard error $\frac{\hat {\sigma} ^2}{N * var(X)}$

## If Assumptions Are Violated

-   When the assumptions of OLS are violated, one of two things might happen:

    -   the slope estimates you calculate will be *biased* (i.e. systematically off from the population slope in one direction or the other)

    -   the calculation of the standard error will be off (too big or too small), leading to potentially erroneous inferences about statistical significance

## Assumption #1

1) Your model is correct

    -   it includes all the right variables (exogeneity assumption)

    -   it takes the correct functional form (linearity assumption)

    -   there's no measurement error

-   violations of these assumptions produce biased estimates of $\hat \beta_1$

## Assumption #2

2) After fitting the model, the errors are independent, normally distributed, with mean 0

    -   the models predictions $\hat Y_i$ are just as likely to be above as below the observed values $Y_i$ all across the range of the data

    -   the errors/residuals have no pattern to them: they are not correlated with each other, with the value of X, or with any other third variable Z

-   violations of these assumptions may also be an indicator of violations of Assumption 1; if not, they may still lead to incorrect standard errors

## Are the assumptions violated?

```{r, echo=FALSE}

ggplot(gapminder, aes(x = gdpPercap, y = lifeExp))+
    geom_point() +
  geom_smooth(method = "lm", formula = y ~ log10(x)) +
  labs(x = "GDP Per Capita", y = "Life Expectancy in Years",
         title = "Economic Development and Life Expectancy",
         subtitle = "Data points are country-years",
         caption = "Source: Gapminder.") + 
  theme_bw()

```

# Recap: Binary Independent Variables

## Let's Separate Oil Countries

```{r}
oil <- c("Kuwait", "Saudi Arabia", "Venezuela", "Norway", "Iran")
gapminder$oil <- factor(ifelse(gapminder$country %in% oil, 1, 0))
```

## Add to Our Model

```{r}
gap.model.oil <- lm(lifeExp~log10(gdpPercap)+ oil, data = gapminder)
summary(gap.model.oil)
```

## Visualized

```{r echo=F}
ggplot(gapminder, aes(x = gdpPercap, y = lifeExp, color = oil))+
    geom_point() +
  geom_abline(slope = 20, intercept = -11, color = "red") +
  geom_abline(slope = 20, intercept = -19, color = "blue") + 
  scale_x_log10() +
  labs(x = "GDP Per Capita", y = "Life Expectancy in Years",
         title = "Economic Development and Life Expectancy",
         subtitle = "Data points are country-years",
         caption = "Source: Gapminder.") + 
  theme_bw()
```

# Recap: Interactions

## Different Slopes

-   binary/categorical variables assign different intercepts, but the slopes remain the same

-   e.g. oil countries have lower life expectancies, but the same relationship between GDP and life expectancy

-   what if we thought the relationship between X and Y changed based on another factor Z?

-   e.g. that increases in GDP have a different effect on life expectancy in oil countries as compared to non-oil countries?

## Interaction Terms

-   we add a term to our model in which we multiply two variables together

-   original model: $\hat{Y} = \hat{\beta_0} + \hat{\beta_1}X_1 + \hat{\beta_2}X_2$

-   interaction model: $\hat Y = \hat\beta_0 + \hat\beta_1X_1 + \hat\beta_2X_2 + \hat\beta_3X_1*X_2$

*What is the slope of* $X_1$ *when* $X_2 = 0$*? When* $X_2 = 1$ *?*

## Dial it up

```{r}

gap.model.int <- lm(lifeExp~log10(gdpPercap)* oil, data = gapminder)
summary(gap.model.int)
```

## On a graph

```{r echo=F}

ggplot(gapminder, aes(x = gdpPercap, y = lifeExp, color = oil))+
    geom_point() +
  geom_abline(slope = 20, intercept = -12, color = "red") +
  geom_abline(slope = 11, intercept = 18, color = "blue") + 
  scale_x_log10() +
  labs(x = "GDP Per Capita", y = "Life Expectancy in Years",
         title = "Economic Development and Life Expectancy",
         subtitle = "Data points are country-years",
         caption = "Source: Gapminder.") + 
  theme_bw()
```

## When to use interactions

-   use an interaction when you think the relationship between X and Y *changes* based on the value of some other variable (Z)

    -   e.g. "I think that additional per capita GDP will have a bigger impact on life expectancy in non-oil countries than oil countries
    
## When NOT to use interactions

-   just add a categorical/dummy control variable when you think some other variable impacts Y, but not the relationship between X and Y

    -   e.g. "I think that oil countries will have lower life expectancies than non-oil countries, irrespective of per capita GDP"

# Recap: Categorical Variables

## Categorical Variables

-   What do you do when you have more than two categories? (e.g. continents?)

-   You create distinct dummy variables for each category: Africa? 1 or 0; Asia? 1 or 0

-   You put the dummy variables in for all categories EXCEPT ONE

-   R will do all this for you automatically if you include a categorical variable in the model

## Implementing a categorical variable

```{r}
gap.model.cont <- lm(lifeExp~log10(gdpPercap) + continent, data = gapminder)
summary(gap.model.cont)
```

## How to pick a reference

-   mathematically, it does not matter

-   BUT, it will impact what shows up as statistically significant in your output

-   e.g. if Europe had been the reference, we would see no stars next to Oceania

-   you can "relevel" you categorical variable to make the reference whatever makes the most intuitive sense

## Re-leveling

```{r}
gapminder$continent2 <- factor(gapminder$continent, 
                               levels = c("Europe", "Africa", "Americas", "Asia", "Oceania"))
gap.model.cont2 <- lm(lifeExp~log10(gdpPercap) + continent2, data = gapminder)
summary(gap.model.cont2)
```

# Binary DVs

## GDP and Olympics

-   are wealthier countries more likely to be selected to host the Olympics?

```{r}
olympics <- c("United States", "Italy", "France", "Norway", "Japan", "United Kingdom", "Greece", "Australia", "China", "South Korea", "Russia", "Austria", "Switzerland")
gapminder$olympics <- ifelse(gapminder$country %in% olympics, 1, 0)
```

## Look at your data!

```{r echo=FALSE}
ggplot(gapminder, aes(x = gdpPercap, y = olympics))+
    geom_point() +
  scale_x_log10() +
  theme_bw()
```

## Linear Probability Model (OLS)

```{r}
olymp.ols <- lm(olympics~log10(gdpPercap), data = gapminder)
summary(olymp.ols)
```

## Visualizing the LPM

```{r echo=FALSE}
ggplot(gapminder, aes(x = gdpPercap, y = olympics))+
    geom_point() +
  geom_abline(slope = .16, intercept = -.49, color = "blue") +
  scale_x_log10() +
  theme_bw()

```

## Logit Models

-   changes the functional form so that it's not linear

-   creates an "S" shape where $\hat Y_i$ cannot exceed 0 or 1

    ![](https://theeffectbook.net/the-effect_files/figure-html/statisticaladjustment-olslogit-1.png){width="700"}

## Logits in R

```{r}
olymp.logit <- glm(olympics~log10(gdpPercap), 
                   family = binomial(link = "logit"), data = gapminder)
summary(olymp.logit)
```

## How to interpret the logit coefficient

-   it's really hard! still positive vs. negative and stars

-   calculate the marginal effect by entering values into the logit equation

-   but the slope of the line changes with X!

-   marginal effect at mean: the slope at the mean of X

-   average marginal effect: the average slope across the entire curve

## Calculating average marginal effect

```{r}
#install.packages(modelsummary)
#install.packages(marginaleffects)
library(modelsummary)
library(marginaleffects)
avg_slopes(olymp.logit, variables = "gdpPercap")
```

## Visually

```{r echo=FALSE}
ggplot(gapminder, aes(x = gdpPercap, y = olympics))+
    geom_point() +
  geom_smooth(method = "lm", se = F) +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), se = F, color = "red") +
  scale_x_log10() +
  theme_bw()


```
